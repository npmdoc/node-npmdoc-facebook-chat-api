<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="https://github.com/Schmavery/facebook-chat-api#readme">facebook-chat-api (v1.3.0)</a>
</h1>
<h4>Facebook chat API that doesn't rely on XMPP.  Will NOT be deprecated April 30th 2015.</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.facebook-chat-api">module facebook-chat-api</a><ol>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">facebook-chat-api.</span>utils</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.facebook-chat-api.utils">module facebook-chat-api.utils</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.arrToForm">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>arrToForm
            <span class="apidocSignatureSpan">(form)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatCookie">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatCookie
            <span class="apidocSignatureSpan">(arr, url)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatDate">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatDate
            <span class="apidocSignatureSpan">(date)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatDeltaMessage">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatDeltaMessage
            <span class="apidocSignatureSpan">(m)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatEvent">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatEvent
            <span class="apidocSignatureSpan">(m)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatMessage">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatMessage
            <span class="apidocSignatureSpan">(m)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatPresence">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatPresence
            <span class="apidocSignatureSpan">(presence, userID)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatRead">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatRead
            <span class="apidocSignatureSpan">(event)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatReadReceipt">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatReadReceipt
            <span class="apidocSignatureSpan">(event)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatThread">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatThread
            <span class="apidocSignatureSpan">(data)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.formatTyp">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatTyp
            <span class="apidocSignatureSpan">(event)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.generateAccessiblityCookie">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generateAccessiblityCookie
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.generateOfflineThreadingID">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generateOfflineThreadingID
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.generatePresence">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generatePresence
            <span class="apidocSignatureSpan">(userID)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.generateThreadingID">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generateThreadingID
            <span class="apidocSignatureSpan">(clientID)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.generateTimestampRelative">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generateTimestampRelative
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.get">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>get
            <span class="apidocSignatureSpan">(url, jar, qs)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.getAppState">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getAppState
            <span class="apidocSignatureSpan">(jar)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.getFrom">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getFrom
            <span class="apidocSignatureSpan">(str, startToken, endToken)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.getGUID">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getGUID
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.getJar">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getJar
            <span class="apidocSignatureSpan">(store)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.getSignatureID">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getSignatureID
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.getType">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getType
            <span class="apidocSignatureSpan">(obj)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.isReadableStream">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>isReadableStream
            <span class="apidocSignatureSpan">(obj)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.makeDefaults">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>makeDefaults
            <span class="apidocSignatureSpan">(html, userID)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.makeParsable">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>makeParsable
            <span class="apidocSignatureSpan">(html)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.parseAndCheckLogin">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>parseAndCheckLogin
            <span class="apidocSignatureSpan">(jar, defaultFuncs)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.post">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>post
            <span class="apidocSignatureSpan">(url, jar, form)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.postFormData">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>postFormData
            <span class="apidocSignatureSpan">(url, jar, form, qs)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.facebook-chat-api.utils.saveCookies">
            function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>saveCookies
            <span class="apidocSignatureSpan">(jar)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.facebook-chat-api" id="apidoc.module.facebook-chat-api">module facebook-chat-api</a></h1>



</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.facebook-chat-api.utils" id="apidoc.module.facebook-chat-api.utils">module facebook-chat-api.utils</a></h1>


    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.arrToForm" id="apidoc.element.facebook-chat-api.utils.arrToForm">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>arrToForm
        <span class="apidocSignatureSpan">(form)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function arrToForm(form) {
  return arrayToObject(form, function(v) {return v.name;}, function(v) {return v.val;});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  arr.push({val: $(v).val(), name: $(v).attr("name")});
});

arr = arr.filter(function(v) {
  return v.val &amp;&amp; v.val.length;
});

var form = utils.<span class="apidocCodeKeywordSpan">arrToForm</span>(arr);
form.lsd = utils.getFrom(html, "[\"LSD\",[],{\"token\":\"", "\"}");
form.lgndim = new Buffer("{\"w\":1440,\"h\":900,\"aw\":1440,\"ah\":834,\"c\"
;:24}").toString('base64');
form.email = email;
form.pass = password;
form.default_persistent = '0';
form.lgnrnd = utils.getFrom(html, "name=\"lgnrnd\" value=\"", "\"");
form.locale = 'en_US';
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatCookie" id="apidoc.element.facebook-chat-api.utils.formatCookie">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatCookie
        <span class="apidocSignatureSpan">(arr, url)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatCookie(arr, url) {
  return arr[0]+"="+arr[1]+"; Path=" + arr[3] + "; Domain="+url+".com";
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
// which happen to be conveniently indicated with a _js_ in front of their
// variable name.
//
// ---------- Very Hacky Part Starts -----------------
var willBeCookies = html.split("\"_js_");
willBeCookies.slice(1).map(function(val) {
  var cookieData = JSON.parse("[\"" + utils.getFrom(val, "", "]") + "]");
  jar.setCookie(utils.<span class="apidocCodeKeywordSpan">formatCookie</span>(cookieData, "facebook"), "https://www
.facebook.com");
});
// ---------- Very Hacky Part Ends -----------------

log.info("login", "Logging in...");
return utils
  .post("https://www.facebook.com/login.php?login_attempt=1&amp;lwv=110", jar, form)
  .then(utils.saveCookies(jar))
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatDate" id="apidoc.element.facebook-chat-api.utils.formatDate">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatDate
        <span class="apidocSignatureSpan">(date)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatDate(date) {
  var d = date.getUTCDate(); d = d &gt;= 10 ? d : '0'+d;
  var h = date.getUTCHours(); h = h &gt;= 10 ? h : '0'+h;
  var m = date.getUTCMinutes(); m = m &gt;= 10 ? m : '0'+m;
  var s = date.getUTCSeconds(); s = s &gt;= 10 ? s : '0'+s;
  return NUM_TO_DAY[date.getUTCDay()] + ', ' +
    d+' '+ NUM_TO_MONTH[date.getUTCMonth()] +' '+ date.getUTCFullYear() +' '+
    h+':'+m+':'+s+' GMT';
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatDeltaMessage" id="apidoc.element.facebook-chat-api.utils.formatDeltaMessage">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatDeltaMessage
        <span class="apidocSignatureSpan">(m)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatDeltaMessage(m){
  var md = m.delta.messageMetadata;
  return {
    type: "message",
    senderID: md.actorFbId,
    body: m.delta.body,
    threadID: (md.threadKey.threadFbId || md.threadKey.otherUserFbId).toString(),
    messageID: md.messageId,
    attachments: (m.delta.attachments || []).map(v =&gt; _formatAttachment(v)),
    timestamp: md.timestamp,
    isGroup: !!md.threadKey.threadFbId
  }
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
break;
            case 'delta':
if (ctx.globalOptions.pageID || (v.delta.class !== "NewMessage" &amp;&amp; !ctx.globalOptions.listenEvents)) return

if (v.delta.class == "NewMessage") {
  (function resolveAttachmentUrl(i) {
    if (i == v.delta.attachments.length) {
      var fmtMsg = utils.<span class="apidocCodeKeywordSpan">formatDeltaMessage</span>(v);
      return (!ctx.globalOptions.selfListen &amp;&amp; fmtMsg.senderID === ctx.userID) ? undefined : globalCallback(null, fmtMsg
);
    } else {
      if (v.delta.attachments[i].mercury.attach_type == 'photo') {
        defaultFuncs
          .get("https://www.facebook.com/mercury/attachments/photo/?photo_id=" + v.delta.attachments[i].fbid, ctx.jar, {})
          .then(utils.parseAndCheckLogin(ctx.jar, defaultFuncs))
          .then(function (resData) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatEvent" id="apidoc.element.facebook-chat-api.utils.formatEvent">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatEvent
        <span class="apidocSignatureSpan">(m)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatEvent(m) {
  var logMessageType;
  var logMessageData;

  // log:thread-color =&gt; {theme_color}
  // log:user-nickname =&gt; {participant_id, nickname}
  // log:thread-icon =&gt; {thread_icon}
  // log:thread-name =&gt; {name}
  // log:subscribe =&gt; {addedParticipants - [Array]}
  // log:unsubscribe =&gt; {leftParticipantFbId}

  switch (m.class) {
    case 'AdminTextMessage':
      logMessageData = m.untypedData;
      switch (m.type) {
        case 'change_thread_theme':
          logMessageType = "log:thread-color";
          break;
        case 'change_thread_nickname':
          logMessageType = "log:user-nickname";
          break;
        case 'change_thread_icon':
          logMessageType = "log:thread-icon";
          break;
      }
      break;
    case 'ThreadName':
      logMessageType = "log:thread-name";
      logMessageData = { name: m.name };
      break;
    case 'ParticipantsAddedToGroupThread':
      logMessageType = "log:subscribe";
      logMessageData = { addedParticipants: m.addedParticipants }
      break;
    case 'ParticipantLeftGroupThread':
      logMessageType = "log:unsubscribe";
      logMessageData = { leftParticipantFbId: m.leftParticipantFbId }
      break;
  }

  return {
    type: "event",
    threadID: m.messageMetadata.threadKey.threadFbId || m.messageMetadata.threadKey.otherUserFbId,
    logMessageType: logMessageType,
    logMessageData: logMessageData,
    logMessageBody: m.messageMetadata.adminText,
    author: m.messageMetadata.actorFbId
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
          break;
        default:
          return;
      }
    case 'ThreadName':
    case 'ParticipantsAddedToGroupThread':
    case 'ParticipantLeftGroupThread':
      var formattedEvent = utils.<span class="apidocCodeKeywordSpan">formatEvent</span>(v.delta);
      return (!ctx.globalOptions.selfListen &amp;&amp; formattedEvent.author.toString() === ctx.userID || !ctx.loggedIn)
        ? undefined
        : globalCallback(null, formattedEvent);
  }

  break;
case 'messaging':
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatMessage" id="apidoc.element.facebook-chat-api.utils.formatMessage">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatMessage
        <span class="apidocSignatureSpan">(m)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatMessage(m) {
  var originalMessage = m.message ? m.message : m;
  var obj = {
    type: "message",
    senderName: originalMessage.sender_name,
    senderID: originalMessage.sender_fbid.toString(),
    participantNames: (originalMessage.group_thread_info ? originalMessage.group_thread_info.participant_names : [originalMessage
.sender_name.split(' ')[0]]),
    participantIDs: (originalMessage.group_thread_info ? originalMessage.group_thread_info.participant_ids.map(function(v) {return
 v.toString();}) : [originalMessage.sender_fbid]),
    body: originalMessage.body,
    threadID: originalMessage.tid &amp;&amp; originalMessage.tid.split(".")[0] === "id" ? originalMessage.tid.split('.')[1] : originalMessage
.thread_fbid || originalMessage.other_user_fbid,
    threadName: (originalMessage.group_thread_info ? originalMessage.group_thread_info.name : originalMessage.sender_name),
    location: originalMessage.coordinates ? originalMessage.coordinates : null,
    messageID: originalMessage.mid ? originalMessage.mid.toString() : originalMessage.message_id,
    attachments: formatAttachment(originalMessage.attachments, originalMessage.attachmentIds, originalMessage.attachment_map, originalMessage
.share_map),
    timestamp: originalMessage.timestamp,
    timestampAbsolute: originalMessage.timestamp_absolute,
    timestampRelative: originalMessage.timestamp_relative,
    timestampDatetime: originalMessage.timestamp_datetime,
    tags: originalMessage.tags
  };

  if(m.type === "pages_messaging") obj.pageID = m.realtime_viewer_fbid.toString();
  obj.isGroup = obj.participantIDs.length &gt; 2;

  return obj;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
                                           v.message.sender_fbid.toString() === ctx.globalOptions.pageID)) ||
        v.realtime_viewer_fbid.toString() !== ctx.globalOptions.pageID) {
        return;
      }

      atLeastOne = true;
      if (ctx.loggedIn) {
        return globalCallback(null, utils.<span class="apidocCodeKeywordSpan">formatMessage</span>(v));
      }
      break;
  }
});

if(atLeastOne) {
  // Send deliveryReceipt notification to the server
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatPresence" id="apidoc.element.facebook-chat-api.utils.formatPresence">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatPresence
        <span class="apidocSignatureSpan">(presence, userID)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatPresence(presence, userID) {
  return {
    type: "presence",
    timestamp: presence.la * 1000,
    userID: userID,
    statuses: presence.a
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  // TODO: what happens when you're logged in as a page?
  if(!ctx.globalOptions.updatePresence) {
    return;
  }

  // There should be only one key inside overlay
  Object.keys(v.overlay).map(function(userID) {
    var formattedPresence = utils.<span class="apidocCodeKeywordSpan">formatPresence</span>(v.overlay[userID], userID);
    if(ctx.loggedIn) {
      return globalCallback(null, formattedPresence);
    }
  });
  break;
case 'delta':
  if (ctx.globalOptions.pageID || (v.delta.class !== "NewMessage" &amp;&amp; !ctx.globalOptions.listenEvents)) return
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatRead" id="apidoc.element.facebook-chat-api.utils.formatRead">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatRead
        <span class="apidocSignatureSpan">(event)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatRead(event) {
  return {
    threadID: ((event.chat_ids &amp;&amp; event.chat_ids[0]) || (event.thread_fbids &amp;&amp; event.thread_fbids[0])).toString(),
    time: event.timestamp,
    type: 'read'
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  switch (event.event) {
    // "read_receipt" event triggers when other people read the user's messages.
    case 'read_receipt':
      globalCallback(null, utils.formatReadReceipt(event));
      return true;
    // "read event" triggers when the user read other people's messages.
    case 'read':
      globalCallback(null, utils.<span class="apidocCodeKeywordSpan">formatRead</span>(event));
      return true;
    default:
      return false;
  }
}

function listen() {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatReadReceipt" id="apidoc.element.facebook-chat-api.utils.formatReadReceipt">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatReadReceipt
        <span class="apidocSignatureSpan">(event)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatReadReceipt(event) {
  return {
    reader: event.reader.toString(),
    time: event.time,
    threadID: (event.thread_fbid || event.reader).toString(),
    type: 'read_receipt',
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
 * and returns true if it did handle an event (and called the globalCallback).
 * Returns false otherwise.
 */
function handleMessagingEvents(event) {
  switch (event.event) {
    // "read_receipt" event triggers when other people read the user's messages.
    case 'read_receipt':
      globalCallback(null, utils.<span class="apidocCodeKeywordSpan">formatReadReceipt</span>(event));
      return true;
    // "read event" triggers when the user read other people's messages.
    case 'read':
      globalCallback(null, utils.formatRead(event));
      return true;
    default:
      return false;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatThread" id="apidoc.element.facebook-chat-api.utils.formatThread">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatThread
        <span class="apidocSignatureSpan">(data)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatThread(data) {
  return {
    threadID: data.thread_fbid.toString(),
    participants: data.participants.map(function(v) { return v.replace('fbid:', ''); }),
    participantIDs: data.participants.map(function(v) { return v.replace('fbid:', ''); }),
    formerParticipants: data.former_participants,
    name: data.name,
    nicknames: data.custom_nickname,
    snippet: data.snippet,
    snippetHasAttachment: data.snippet_has_attachment,
    snippetAttachments: data.snippet_attachments,
    snippetSender: (data.snippet_sender || '').replace('fbid:', ''),
    unreadCount: data.unread_count,
    messageCount: data.message_count,
    imageSrc: data.image_src,
    timestamp: data.timestamp,
    serverTimestamp: data.server_timestamp, // what is this?
    muteSettings: data.muteSettings,
    isCanonicalUser: data.is_canonical_user,
    isCanonical: data.is_canonical,
    canonicalFbid: data.canonical_fbid,
    isSubscribed: data.is_subscribed,
    rootMessageThreadingID: data.root_message_threading_id,
    folder: data.folder,
    isArchived: data.is_archived,
    recipientsLoadable: data.recipients_loadable,
    hasEmailParticipant: data.has_email_participant,
    readOnly: data.read_only,
    canReply: data.can_reply,
    composerEnabled: data.composer_enabled,
    blockedParticipants: data.blocked_participants,
    lastMessageID: data.last_message_id
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.formatTyp" id="apidoc.element.facebook-chat-api.utils.formatTyp">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>formatTyp
        <span class="apidocSignatureSpan">(event)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function formatTyp(event) {
  return {
    isTyping: !!event.st,
    from: event.from.toString(),
    threadID: (event.to || event.thread_fbid || event.from).toString(),
    // When receiving typ indication from mobile, `from_mobile` isn't set.
    // If it is, we just use that value.
    fromMobile: event.hasOwnProperty('from_mobile') ? event.from_mobile : true,
    userID: (event.realtime_viewer_fbid || event.from).toString(),
    type: 'typ',
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
case 'ttyp':
case 'typ':
  if(!ctx.globalOptions.listenEvents ||
    (!ctx.globalOptions.selfListen &amp;&amp; v.from.toString() === ctx.userID)) {
    return;
  }

  return globalCallback(null, utils.<span class="apidocCodeKeywordSpan">formatTyp</span>(v));
  break;
case 'buddylist_overlay':
  // TODO: what happens when you're logged in as a page?
  if(!ctx.globalOptions.updatePresence) {
    return;
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.generateAccessiblityCookie" id="apidoc.element.facebook-chat-api.utils.generateAccessiblityCookie">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generateAccessiblityCookie
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function generateAccessiblityCookie() {
  var time = Date.now();
  return encodeURIComponent(
    JSON.stringify({
      sr: 0,
      'sr-ts': time,
      jk: 0,
      'jk-ts': time,
      kb: 0,
      'kb-ts': time,
      hcm: 0,
      'hcm-ts': time
    }
  ));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  msgs_recv: 0
};
var presence = utils.generatePresence(ctx.userID);
ctx.jar.setCookie("presence=" + presence + "; path=/; domain=.facebook.com; secure", "https://www.facebook
.com");
ctx.jar.setCookie("presence=" + presence + "; path=/; domain=.messenger.com; secure", "https://www.messenger
.com");
ctx.jar.setCookie("locale=en_US; path=/; domain=.facebook.com; secure", "https://www.facebook.com");
ctx.jar.setCookie("locale=en_US; path=/; domain=.messenger.com; secure", "https://www.messenger.com");
ctx.jar.setCookie("a11y=" + utils.<span class="apidocCodeKeywordSpan">generateAccessiblityCookie</span>() + "; path
=/; domain=.facebook.com; secure", "https://www.facebook.com");

return utils
  .get("https://0-edge-chat.facebook.com/pull", ctx.jar, form)
  .then(utils.saveCookies(ctx.jar))
  .then(function(res) {
    var ret = null;
    try {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.generateOfflineThreadingID" id="apidoc.element.facebook-chat-api.utils.generateOfflineThreadingID">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generateOfflineThreadingID
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function generateOfflineThreadingID() {
  var ret = Date.now();
  var value = Math.floor(Math.random() * 4294967295);
  var str = ("0000000000000000000000" + value.toString(2)).slice(-22);
  var msgs = ret.toString(2) + str;
  return binaryToDecimal(msgs);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  throw {error: "ThreadID should be of type Number or String and not " + utils.getType(threadID) + "."};
}

if (utils.getType(userID) !== "Array") {
  userID = [userID];
}

var messageAndOTID = utils.<span class="apidocCodeKeywordSpan">generateOfflineThreadingID</span>();
var form = {
  'client' : 'mercury',
  'action_type' : 'ma-type:log-message',
  'author' : 'fbid:' + ctx.userID,
  'thread_id' : '',
  'timestamp' : Date.now(),
  'timestamp_absolute' : 'Today',
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.generatePresence" id="apidoc.element.facebook-chat-api.utils.generatePresence">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generatePresence
        <span class="apidocSignatureSpan">(userID)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function generatePresence(userID) {
  var time = Date.now();
  return "E" + presenceEncode(JSON.stringify({
    "v": 3,
    "time": parseInt(time / 1000, 10),
    "user": userID,
    "state": {
      "ut": 0,
      "t2": [],
      "lm2": null,
      "uct2": time,
      "tr": null,
      "tw": Math.floor(Math.random() * 4294967295) + 1,
      "at": time
    },
    "ch":{
      ["p_" + userID]: 0
    }
  }))
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  viewer_uid : ctx.userID,
  uid : ctx.userID,
  state : 'active',
  idle : 0,
  cap : 8,
  msgs_recv: 0
};
var presence = utils.<span class="apidocCodeKeywordSpan">generatePresence</span>(ctx.userID);
ctx.jar.setCookie("presence=" + presence + "; path=/; domain=.facebook.com; secure", "https://www.facebook
.com");
ctx.jar.setCookie("presence=" + presence + "; path=/; domain=.messenger.com; secure", "https://www.messenger
.com");
ctx.jar.setCookie("locale=en_US; path=/; domain=.facebook.com; secure", "https://www.facebook.com");
ctx.jar.setCookie("locale=en_US; path=/; domain=.messenger.com; secure", "https://www.messenger.com");
ctx.jar.setCookie("a11y=" + utils.generateAccessiblityCookie() + "; path=/; domain=.facebook.com; secure", &amp;#
x22;https://www.facebook.com");

return utils
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.generateThreadingID" id="apidoc.element.facebook-chat-api.utils.generateThreadingID">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generateThreadingID
        <span class="apidocSignatureSpan">(clientID)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function generateThreadingID(clientID) {
  var k = Date.now();
  var l = Math.floor(Math.random() * 4294967295);
  var m = clientID;
  return ("&lt;" + k + ":" + l + "-" + m + "@mail.projektitan.com&gt;");
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  'is_spoof_warning' : false,
  'source' : 'source:chat:web',
  'source_tags[0]' : 'source:chat',
  'log_message_type' : 'log:subscribe',
  'status' : '0',
  'offline_threading_id' : messageAndOTID,
  'message_id' : messageAndOTID,
  'threading_id': utils.<span class="apidocCodeKeywordSpan">generateThreadingID</span>(ctx.clientID),
  'manual_retry_cnt' : '0',
  'thread_fbid' : threadID,
};

for (var i = 0; i &lt; userID.length; i++){
  if (utils.getType(userID[i]) !== "Number" &amp;&amp; utils.getType(userID[i]) !== "String") {
    throw {error: "Elements of userID should be of type Number or String and not " + utils.getType(userID[i]) + ".&amp;#
x22;};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.generateTimestampRelative" id="apidoc.element.facebook-chat-api.utils.generateTimestampRelative">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>generateTimestampRelative
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function generateTimestampRelative() {
  var d = new Date();
  return d.getHours() + ":" + padZeros(d.getMinutes());
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    var form = {
'client' : 'mercury',
'action_type' : 'ma-type:log-message',
'author' : 'fbid:' + ctx.userID,
'thread_id' : '',
'timestamp' : Date.now(),
'timestamp_absolute' : 'Today',
'timestamp_relative' : utils.<span class="apidocCodeKeywordSpan">generateTimestampRelative</span>(),
'timestamp_time_passed' : '0',
'is_unread' : false,
'is_cleared' : false,
'is_forward' : false,
'is_filtered_content' : false,
'is_filtered_content_bh':false,
'is_filtered_content_account':false,
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.get" id="apidoc.element.facebook-chat-api.utils.get">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>get
        <span class="apidocSignatureSpan">(url, jar, qs)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function get(url, jar, qs) {
  // I'm still confused about this
  if(getType(qs) === "Object") {
    for(var prop in qs) {
      if(qs.hasOwnProperty(prop) &amp;&amp; getType(qs[prop]) === "Object") {
        qs[prop] = JSON.stringify(qs[prop]);
      }
    }
  }
  var op = {
    headers: getHeaders(url),
    timeout: 60000,
    qs: qs,
    url: url,
    method: "GET",
    jar: jar,
    gzip: true
  };

  return request(op).then(function(res) {return res[0];});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
        }

        // This means the account has login approvals turned on.
        if (headers.location.indexOf('https://www.facebook.com/checkpoint/') &gt; -1) {
var nextURL = 'https://www.facebook.com/checkpoint/?next=https%3A%2F%2Fwww.facebook.com%2Fhome.php';

return utils
  .<span class="apidocCodeKeywordSpan">get</span>(headers.location, jar)
  .then(utils.saveCookies(jar))
  .then(function(res) {
    var html = res.body;
    // Make the form in advance which will contain the fb_dtsg and nh
    var $ = cheerio.load(html);
    var arr = [];
    $("form input").map(function(i, v){
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.getAppState" id="apidoc.element.facebook-chat-api.utils.getAppState">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getAppState
        <span class="apidocSignatureSpan">(jar)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getAppState(jar){
  return jar
    .getCookies("https://www.facebook.com")
    .concat(jar.getCookies("https://facebook.com"))
    .concat(jar.getCookies("https://www.messenger.com"));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
2. Why doesn't `sendMessage` always work when I'm logged in as a page?
&gt; Pages can't start conversations with users directly; this is to prevent pages from spamming users.

3. What do I do when `login` doesn't work?
&gt; First check that you can login to Facebook using the website. If login approvals are enabled, you might be logging in incorrectly
. For how to handle login approvals, read our docs on [`login`](DOCS.md#login).

4. How can I avoid logging in every time?  Can I log into a previous session?
&gt; We support caching everything relevant for you to bypass login. `api.<span class="apidocCodeKeywordSpan">getAppState</span>()` returns an object that you can save and pass into login as `{appState: mySavedAppState}` instead of the credentials object.
If this fails, your session has expired.

5. Do you support sending messages as a page?
&gt; Yes, set the pageID option on login (this doesn't work if you set it using api.setOptions, it affects the login process
).
&gt; ```js
&gt; login(credentials, {pageID: xxxxx}, function(api) { ... }
&gt; ```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.getFrom" id="apidoc.element.facebook-chat-api.utils.getFrom">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getFrom
        <span class="apidocSignatureSpan">(str, startToken, endToken)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getFrom(str, startToken, endToken) {
  var start = str.indexOf(startToken) + startToken.length;
  if(start &lt; startToken.length) return "";

  var lastHalf = str.substring(start);
  var end = lastHalf.indexOf(endToken);
  if (end === -1) {
    throw Error("Could not find endTime `" + endToken + "` in the given string.");
  }
  return lastHalf.substring(0, end);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
});

arr = arr.filter(function(v) {
  return v.val &amp;&amp; v.val.length;
});

var form = utils.arrToForm(arr);
form.lsd = utils.<span class="apidocCodeKeywordSpan">getFrom</span>(html, "[\"LSD\",[],{\"token\":\"
;", "\"}");
form.lgndim = new Buffer("{\"w\":1440,\"h\":900,\"aw\":1440,\"ah\":834,\"c\"
;:24}").toString('base64');
form.email = email;
form.pass = password;
form.default_persistent = '0';
form.lgnrnd = utils.getFrom(html, "name=\"lgnrnd\" value=\"", "\"");
form.locale = 'en_US';
form.timezone = '240';
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.getGUID" id="apidoc.element.facebook-chat-api.utils.getGUID">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getGUID
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getGUID() {
<span class="apidocCodeCommentSpan">  /** @type {number} */
</span>  var sectionLength = Date.now();
  /** @type {string} */
  var id = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
    /** @type {number} */
    var r = Math.floor((sectionLength + Math.random() * 16) % 16);
    /** @type {number} */
    sectionLength = Math.floor(sectionLength / 16);
    /** @type {string} */
    var _guid = (c == "x" ? r : r &amp; 7 | 8).toString(16);
    return _guid;
  });
  return id;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

var form = {
  'value' : name.toLowerCase(),
  'viewer' : ctx.userID,
  'rsp' : "search",
  'context' : "search",
  'path' : "/home.php",
  'request_id' : utils.<span class="apidocCodeKeywordSpan">getGUID</span>(),
};

defaultFuncs
  .get("https://www.facebook.com/ajax/typeahead/search.php", ctx.jar, form)
  .then(utils.parseAndCheckLogin(ctx.jar, defaultFuncs))
  .then(function(resData) {
    if (resData.error) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.getJar" id="apidoc.element.facebook-chat-api.utils.getJar">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getJar
        <span class="apidocSignatureSpan">(store)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getJar = function (store) {
  return cookies.jar(store)
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    });
};
}

// Helps the login
function loginHelper(appState, email, password, globalOptions, callback) {
var mainPromise = null;
var jar = utils.<span class="apidocCodeKeywordSpan">getJar</span>();

// If we're given an appState we loop through it and save each cookie
// back into the jar.
if(appState) {
  appState.map(function(c) {
    var str = c.key + "=" + c.value + "; expires=" + c.expires + "; domain=" + c.domain + ";
path=" + c.path + ";";
    jar.setCookie(str, "http://" + c.domain);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.getSignatureID" id="apidoc.element.facebook-chat-api.utils.getSignatureID">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getSignatureID
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getSignatureID(){
  return Math.floor(Math.random() * 2147483648).toString(16);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    'status' : '0',
    'offline_threading_id' : messageAndOTID,
    'message_id' : messageAndOTID,
    'threading_id': utils.generateThreadingID(ctx.clientID),
    'ephemeral_ttl_mode:': '0',
    'manual_retry_cnt' : '0',
    'has_attachment' : !!(msg.attachment || msg.url || msg.sticker),
    'signatureID' : utils.<span class="apidocCodeKeywordSpan">getSignatureID</span>(),
  };

  handleSticker(msg, form, callback,
    () =&gt; handleAttachment(msg, form, callback,
      () =&gt; handleUrl(msg, form, callback,
        () =&gt; send(form, threadID, messageAndOTID, callback))));
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.getType" id="apidoc.element.facebook-chat-api.utils.getType">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>getType
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function getType(obj) {
  return Object.prototype.toString.call(obj).slice(8, -1);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  .catch(function(e) {
    log.error("login", e.error || e);
    callback(e);
  });
}

function login(loginData, options, callback) {
if(utils.<span class="apidocCodeKeywordSpan">getType</span>(options) === 'Function') {
  callback = options;
  options = {};
}

var globalOptions = {
  selfListen: false,
  listenEvents: false,
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.isReadableStream" id="apidoc.element.facebook-chat-api.utils.isReadableStream">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>isReadableStream
        <span class="apidocSignatureSpan">(obj)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function isReadableStream(obj) {
  return obj instanceof stream.Stream &amp;&amp;
    getType(obj._read) === 'Function' &amp;&amp;
    getType(obj._readableState) === 'Object';
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

module.exports = function(defaultFuncs, api, ctx) {
  function uploadAttachment(attachments, callback) {
    var uploads = [];

    // create an array of promises
    for (var i = 0; i &lt; attachments.length; i++) {
if (!utils.<span class="apidocCodeKeywordSpan">isReadableStream</span>(attachments[i])) {
  throw {error: "Attachment should be a readable stream and not " + utils.getType(attachments[i]) + "."};
}

var form = {
  upload_1024: attachments[i],
  'voice_clip': 'true',
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.makeDefaults" id="apidoc.element.facebook-chat-api.utils.makeDefaults">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>makeDefaults
        <span class="apidocSignatureSpan">(html, userID)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function makeDefaults(html, userID) {
  var reqCounter = 1;
  var fb_dtsg = getFrom(html, "name=\"fb_dtsg\" value=\"", "\"");
  var ttstamp = "";
  for (var i = 0; i &lt; fb_dtsg.length; i++) {
    ttstamp += fb_dtsg.charCodeAt(i);
  }
  ttstamp += '2';
  var revision = getFrom(html, "revision\":",",");

  function mergeWithDefaults(obj) {
    var newObj = {
      __user: userID,
      __req: (reqCounter++).toString(36),
      __rev: revision,
      __a: 1,
      fb_dtsg: fb_dtsg,
      ttstamp: ttstamp,
    };

    if(!obj) return newObj;

    for(var prop in obj) {
      if(obj.hasOwnProperty(prop)) {
        if (!newObj[prop]) {
          newObj[prop] = obj[prop];
        }
      }
    }

    return newObj;
  }

  function postWithDefaults(url, jar, form) {
    return post(url, jar, mergeWithDefaults(form));
  }

  function getWithDefaults(url, jar, qs) {
    return get(url, jar, mergeWithDefaults(qs));
  }

  function postFormDataWithDefault(url, jar, form, qs) {
    return postFormData(url, jar, mergeWithDefaults(form), mergeWithDefaults(qs));
  }

  return {
    get: getWithDefaults,
    post: postWithDefaults,
    postFormData: postFormDataWithDefault,
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  'removeUserFromGroup',
  'searchForThread',
  'sendMessage',
  'sendTypingIndicator',
  'setTitle',
];

var defaultFuncs = utils.<span class="apidocCodeKeywordSpan">makeDefaults</span>(html, userID);

// Load all api functions in a loop
apiFuncNames.map(function(v) {
  api[v] = require('./src/' + v)(defaultFuncs, api, ctx);
});

return [ctx, defaultFuncs, api];
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.makeParsable" id="apidoc.element.facebook-chat-api.utils.makeParsable">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>makeParsable
        <span class="apidocSignatureSpan">(html)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function makeParsable(html) {
  return html.replace(/for\s*\(\s*;\s*;\s*\)\s*;\s*/, "");
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

  return utils
    .get("https://0-edge-chat.facebook.com/pull", ctx.jar, form)
    .then(utils.saveCookies(ctx.jar))
    .then(function(res) {
      var ret = null;
      try {
        ret = JSON.parse(utils.<span class="apidocCodeKeywordSpan">makeParsable</span>(res.body));
      } catch(e) {
        throw {error: "Error inside first pull request. Received HTML instead of JSON. Logging in inside a browser might help
 fix this."};
      }

      return ret;
    });
})
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.parseAndCheckLogin" id="apidoc.element.facebook-chat-api.utils.parseAndCheckLogin">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>parseAndCheckLogin
        <span class="apidocSignatureSpan">(jar, defaultFuncs)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function parseAndCheckLogin(jar, defaultFuncs) {
  return function(data) {
    return bluebird.try(function() {
      log.verbose("parseAndCheckLogin", data.body);
      if (data.statusCode &gt;= 500 &amp;&amp; data.statusCode &lt; 600) {
        log.warn("parseAndCheckLogin", "Got status code " + data.statusCode + " retrying...");
        var url = data.request.uri.protocol + "//" + data.request.uri.hostname + data.request.uri.pathname;
        if (data.request.headers['Content-Type'].split(";")[0] === "multipart/form-data") {
          return defaultFuncs
            .postFormData(url, jar, data.request.formData, {})
            .then(parseAndCheckLogin(jar));
        } else {
          return defaultFuncs
            .post(url, jar, data.request.formData)
            .then(parseAndCheckLogin(jar));
        }
      }
      if (data.statusCode !== 200) throw new Error("parseAndCheckLogin got status code: " + data.statusCode + ". Bailing out of
trying to parse response.");

      var res = null;
      try {
        res = JSON.parse(makeParsable(data.body));
      } catch(e) {
        throw {
          error: "JSON.parse error. Check the `detail` property on this error.",
          detail: e,
          res: data.body
        };
      }

      // TODO: handle multiple cookies?
      if (res.jsmods
          &amp;&amp; res.jsmods.require
          &amp;&amp; Array.isArray(res.jsmods.require[0])
          &amp;&amp; res.jsmods.require[0][0] === "Cookie") {
        res.jsmods.require[0][3][0] = res.jsmods.require[0][3][0].replace("_js_", "");
        var cookie = formatCookie(res.jsmods.require[0][3], "facebook");
        var cookie2 = formatCookie(res.jsmods.require[0][3], "messenger");
        jar.setCookie(cookie, "https://www.facebook.com");
        jar.setCookie(cookie2, "https://www.messenger.com");
      }

      if (res.error === 1357001) {
        throw {error: "Not logged in."};
      }
      return res;
    });
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    throw {error: "Elements of userID should be of type Number or String and not " + utils.getType(userID[i]) + ".&amp;#
x22;};
  }

  form['log_message_data[added_participants]['+i+']'] = 'fbid:' + userID[i];
}

defaultFuncs.post("https://www.facebook.com/messaging/send/", ctx.jar, form)
.then(utils.<span class="apidocCodeKeywordSpan">parseAndCheckLogin</span>(ctx.jar, defaultFuncs))
.then(function(resData) {
  if (!resData) {
    throw {error: "Add to group failed."};
  }
  if(resData.error) {
    throw resData;
  }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.post" id="apidoc.element.facebook-chat-api.utils.post">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>post
        <span class="apidocSignatureSpan">(url, jar, form)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function post(url, jar, form) {
  var op = {
    headers: getHeaders(url),
    timeout: 60000,
    url: url,
    method: "POST",
    form: form,
    jar: jar,
    gzip: true
  };

  return request(op).then(function(res) {return res[0];});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  var cookieData = JSON.parse("[\"" + utils.getFrom(val, "", "]") + "]");
  jar.setCookie(utils.formatCookie(cookieData, "facebook"), "https://www.facebook.com");
});
// ---------- Very Hacky Part Ends -----------------

log.info("login", "Logging in...");
return utils
  .<span class="apidocCodeKeywordSpan">post</span>("https://www.facebook.com/login.php?login_attempt=1&amp;lwv=110",
jar, form)
  .then(utils.saveCookies(jar))
  .then(function(res) {
    var headers = res.headers;
    if (!headers.location) {
      throw {error: "Wrong username/password."};
    }
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.postFormData" id="apidoc.element.facebook-chat-api.utils.postFormData">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>postFormData
        <span class="apidocSignatureSpan">(url, jar, form, qs)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function postFormData(url, jar, form, qs) {
  var headers = getHeaders(url);
  headers['Content-Type'] = 'multipart/form-data';
  var op = {
    headers: headers,
    timeout: 60000,
    url: url,
    method: "POST",
    formData: form,
    qs: qs,
    jar: jar,
    gzip: true
  };

  return request(op).then(function(res) {return res[0];});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

    var form = {
      'images_only': 'true',
      'attachment[]': image,
    };

    uploads.push(defaultFuncs
      .<span class="apidocCodeKeywordSpan">postFormData</span>("https://upload.facebook.com/ajax/mercury/upload.php",
ctx.jar, form, {})
      .then(utils.parseAndCheckLogin(ctx.jar, defaultFuncs))
      .then(function (resData) {
if (resData.error) {
  throw resData;
}

return resData.payload.metadata[0];
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.facebook-chat-api.utils.saveCookies" id="apidoc.element.facebook-chat-api.utils.saveCookies">
        function <span class="apidocSignatureSpan">facebook-chat-api.utils.</span>saveCookies
        <span class="apidocSignatureSpan">(jar)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function saveCookies(jar) {
  return function(res) {
    var cookies = res.headers['set-cookie'] || [];
    cookies.forEach(function (c) {
      if (c.indexOf(".facebook.com") &gt; -1) {
        jar.setCookie(c, "https://www.facebook.com");
      }
      var c2 = c.replace(/domain=\.facebook\.com/, "domain=.messenger.com");
      jar.setCookie(c2, "https://www.messenger.com");
    });
    return res;
  };
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      jar.setCookie(utils.formatCookie(cookieData, "facebook"), "https://www.facebook.com");
    });
    // ---------- Very Hacky Part Ends -----------------

    log.info("login", "Logging in...");
    return utils
      .post("https://www.facebook.com/login.php?login_attempt=1&amp;lwv=110", jar, form)
      .then(utils.<span class="apidocCodeKeywordSpan">saveCookies</span>(jar))
      .then(function(res) {
var headers = res.headers;
if (!headers.location) {
  throw {error: "Wrong username/password."};
}

// This means the account has login approvals turned on.
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>